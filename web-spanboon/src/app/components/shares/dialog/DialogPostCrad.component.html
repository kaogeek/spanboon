<!--
    @license Spanboon Platform v0.1
    (c) 2020-2021 KaoGeek. http://kaogeek.dev
    License: MIT. https://opensource.org/licenses/MIT
    Author:  p-nattawadee <nattawdee.l@absolute.co.th>, Chanachai-Pansailom <chanachai.p@absolute.co.th>, Americaso <treerayuth.o@absolute.co.th>
-->
<ng-container *ngIf="data.vote; else elseTemplate">
    <div *ngIf="!voteSuccess" class="dialog-vote-card">
        <div class="wrapper-card">
            <img class="close-icon" src="../../../../assets/img/icons/votepage/close.svg" role="button"
                (click)="onClose(data.menu)">
            <div class="card-wrapper">
                <div class="image">
                    <div class="wrapper-image">
                        <div class="image-cover-blur"
                            [ngStyle]="{'background-image': 'linear-gradient(to bottom, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(' +  apiBaseURL + data.post.coverPageURL + '/image' + ')'}">
                        </div>
                        <ng-container *ngIf="!!data.post.coverPageURL; else elseVoteImageNull">
                            <img class="image-vote" [src]="apiBaseURL + data.post.coverPageURL + '/image'" alt="">
                        </ng-container>
                        <ng-template #elseVoteImageNull>
                            <img class="image-vote" src="../../../../assets/img/logo/vote-01.jpg" alt="">
                        </ng-template>
                        <div class="bottom-vote">
                            <div class="type-vote">
                                <div class="status-vote"
                                    [ngClass]="{'public': data.post.type === 'public' || data.post.type === 'private','member': data.post.type === 'member'}">
                                </div>
                                <span>{{data.post.type === 'public' ? 'ทั่วไป' : (data.post.type === 'member' ?
                                    'สมาชิกพรรค' : 'ส่วนตัว')}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="bottom-image">
                        <div class="wrapper-detail-vote">
                            <div class="user-profile">
                                <ng-container *ngIf="!!user.imageURL; else elseImageNull">
                                    <img [src]="apiBaseURL + user.imageURL + '/image'" alt="">
                                </ng-container>
                                <ng-template #elseImageNull>
                                    <span>{{user.firstName | slice:0:1}}</span>
                                </ng-template>
                            </div>
                            <ng-container
                                *ngIf="!data.post.approved && data.post.status !== 'close'; else elseTemplate">
                                <div class="owner-name">
                                    <span>{{user.firstName !== undefined ? user.firstName : user.pageUsername}}</span>
                                    <mat-progress-bar mode="determinate" [value]="supportValue">
                                    </mat-progress-bar>
                                    <ng-container
                                        *ngIf="(data.post.minSupport - data.post.countSupport) <= 0; else elseMinSupport">
                                        <span>กระทู้ของคุณได้รับฉันทมติให้เปิดโหวต</span>
                                    </ng-container>
                                    <ng-template #elseMinSupport>
                                        <span>ยังต้องการอีก {{data.post.minSupport - data.post.countSupport}} เสียง
                                            เพื่อเปิดโหวต</span>
                                    </ng-template>
                                </div>
                            </ng-container>
                            <ng-template #elseTemplate>
                                <div class="owner-name">
                                    <span>{{user.firstName !== undefined ? user.firstName : user.pageUsername}}</span>
                                    <ng-container
                                        *ngIf="!data.post.closed && data.post.endVoteDay >= 0; else elseClosed">
                                        <span>
                                            <span>{{data.post.status === 'vote' ? 'ปิดโหวตใน' : 'ปิดลงชื่อใน'}} </span>
                                            <ng-container *ngIf="data.post.endVoteDay > 0">
                                                <span>{{!data.post.isMoreThanMonth ? data.post.endVoteDay :
                                                    data.post.endVoteDay |
                                                    customDateFormat}}</span>
                                                <span *ngIf="!data.post.isMoreThanMonth"> วัน </span>
                                            </ng-container>
                                            <ng-container
                                                *ngIf="data.post.endVoteHour > 0 && data.post.endVoteDay <= 0">
                                                <span>{{data.post.endVoteHour}}</span>
                                                <span> ชั่วโมง</span>
                                            </ng-container>
                                            <ng-container
                                                *ngIf="data.post.endVoteDay <= 0 && data.post.endVoteHour <= 0">
                                                <span>{{data.post.endVoteMinute}}</span>
                                                <span> นาที</span>
                                            </ng-container>
                                        </span>
                                    </ng-container>
                                    <ng-template #elseClosed>
                                        <span>ปิดโหวตแล้ว</span>
                                    </ng-template>
                                </div>
                            </ng-template>
                        </div>
                        <div class="share-button-vote" (click)="shareVote()">
                            <img src="../../../../assets/img/icons/votepage/share.svg" alt="">
                        </div>
                    </div>
                </div>
                <div class="box-content">
                    <div class="title">
                        <!-- <div [innerHTML]="data.post.title | readmore:300"></div> -->
                        <div>{{data.post.title}}</div>
                    </div>
                    <div class="title detail">
                        <div>{{data.post.detail}}</div>
                    </div>
                    <div class="title hashtag" *ngIf="!!data.post.hashTag">
                        <span>#{{data.post.hashTag}}</span>
                    </div>
                    <hr>
                    <div class="user-vote">
                        <ng-container *ngIf="(data.support === undefined); else elseSupportUser">
                            <ng-container *ngIf="data.post.showVoterName">
                                <ng-container *ngFor="let item of data.choice.voted">
                                    <div class="user-profile">
                                        <ng-container *ngIf="!!item.user.imageURL; else elseImageNullVote">
                                            <img [src]="apiBaseURL + item.user.imageURL + '/image'" alt="">
                                        </ng-container>
                                        <ng-template #elseImageNullVote>
                                            <span>{{item.user.displayName | slice:0:1}}</span>
                                        </ng-template>
                                    </div>
                                </ng-container>
                                <ng-container *ngIf="data.choice.voted.length <= 5 && data.choice.voted.length > 0">
                                    <span>{{data.choice.voted[data.choice.voted.length - 1].user.displayName}}
                                        ...คนเหล่านี้โหวตแล้ว</span>
                                </ng-container>
                                <ng-container *ngIf="data.choice.voted.length > 5 && data.choice.voted.length > 0">
                                    <span>{{data.choice.voted[data.choice.voted.length - 1].user.displayName}}
                                        ...และอีก
                                        {{data.choice.voteCount - data.choice.voted.length}}
                                        คนโหวตแล้ว</span>
                                </ng-container>
                            </ng-container>
                            <ng-container *ngIf="data.choice.voted.length === 0; else elseVoteLength">
                                <ng-container *ngIf="data.choice.showVoterName; else elseVoteShowName">
                                    <span style="margin-left: 0px;padding: 9px;">{{data.post.status === 'close' ?
                                        'ไม่มีคนโหวตหัวข้อนี้' : 'ขณะนี้ยังไม่มีคนโหวตหัวข้อนี้'}}</span>
                                </ng-container>
                                <ng-template #elseVoteShowName>
                                    <span style="padding: 9px;"
                                        [ngStyle]="{'margin-left': data.choice.voteCount > 0 && data.post.showVoterName ? '10px' : '0px'}"
                                        [innerHTML]="data.choice.voteCount > 0 ? 'โหวตนี้มีผู้โหวตแล้วทั้งหมด ' + data.choice.voteCount + ' คน' : (data.post.status === 'close' ? 'ไม่มีคนโหวตหัวข้อนี้' : 'ขณะนี้ยังไม่มีคนโหวตหัวข้อนี้')"></span>
                                </ng-template>
                            </ng-container>
                            <ng-template #elseVoteLength>
                                <span *ngIf="!data.post.showVoterName"
                                    style="margin-left: 0px;padding: 9px;">โหวตนี้มีผู้โหวตแล้วทั้งหมด
                                    {{data.choice.voteCount}} คน</span>
                            </ng-template>
                        </ng-container>
                        <ng-template #elseSupportUser>
                            <ng-container *ngIf="data.post.showVoterName">
                                <ng-container *ngFor="let item of data.support.userSupport">
                                    <div class="user-profile">
                                        <ng-container *ngIf="!!item.user.imageURL; else elseImageNullSupport">
                                            <img [src]="apiBaseURL + item.user.imageURL + '/image'" alt="">
                                        </ng-container>
                                        <ng-template #elseImageNullSupport>
                                            <span>{{item.user.firstName | slice:0:1}}</span>
                                        </ng-template>
                                    </div>
                                </ng-container>
                                <ng-container
                                    *ngIf="data.support.userSupport.length <= 5 && data.support.userSupport.length > 0">
                                    <span>{{data.support.userSupport[data.support.userSupport.length -
                                        1].user.displayName}}
                                        ...คนเหล่านี้สนับสนุนแล้ว</span>
                                </ng-container>
                                <ng-container
                                    *ngIf="data.support.userSupport.length > 5 && data.support.userSupport.length > 0">
                                    <span>{{data.support.userSupport[data.support.userSupport.length -
                                        1].user.displayName}}
                                        ...และอีก
                                        {{data.choice.count - data.support.userSupport.length}}
                                        สนับสนุนแล้ว</span>
                                </ng-container>
                            </ng-container>

                            <ng-container *ngIf="data.support.userSupport.length === 0; else elseSupportLength">
                                <ng-container *ngIf="data.choice.showVoterName; else elseSupportShowName">
                                    <span style="margin-left: 0px;padding: 9px;">ขณะนี้ยังไม่มีคนสนับสนุนโหวตนี้</span>
                                </ng-container>
                                <ng-template #elseSupportShowName>
                                    <span style="margin-left: 10px;padding: 9px;"
                                        [innerHTML]="data.post.countSupport === 0 ? 'ขณะนี้ยังไม่มีคนสนับสนุนโหวตนี้' : 'โหวตนี้มีผู้สนับสนุนแล้วทั้งหมด ' + data.post.countSupport + ' คน'"></span>
                                </ng-template>
                            </ng-container>
                            <ng-template #elseSupportLength>
                                <span *ngIf="!data.post.showVoterName"
                                    style="margin-left: 10px;padding: 9px;">โหวตนี้มีผู้สนับสนุนแล้วทั้งหมด
                                    {{data.post.countSupport}} คน</span>
                            </ng-template>
                        </ng-template>
                    </div>
                    <hr>
                    <span class="show-voter-name" *ngIf="data.post.status !== 'support'">{{data.post.showVoterName ?
                        'โหวตนี้มีการแสดงชื่อผู้โหวต' :
                        'โหวตนี้ไม่แสดงชื่อผู้โหวต'}}</span>
                    <ng-container *ngIf="data.post.status === 'support'">
                        <div class="detail-vote-support">
                            <span>โหวตจะเปิดให้ลงคะแนน เมื่อได้รับการสนับสนุนครบ {{data.post.minSupport}} คน ภายใน
                                {{data.post.supportDaysRange}} วัน</span>
                            <span>ร่วมลงชื่อสนับสนุนได้ที่ด้านล่าง</span>
                        </div>
                    </ng-container>

                    <ng-container *ngIf="data.post.approved; else elseApproved">
                        <ng-container *ngFor="let item of posts;let index = index">
                            <div class="question">
                                <span>คำถามที่ {{item.ordering}}</span>
                                <img *ngIf="!!item!.coverPageURL" [src]="apiBaseURL + item?.coverPageURL + '/image'"
                                    alt="">
                                <span class="title">{{item.title}}</span>
                                <ng-container *ngFor="let choice of item.voteChoice;let i = index">
                                    <ng-container *ngIf="item.type === 'single'; else elseMultiple">
                                        <div class="wrapper-choice" role="button"
                                            [ngClass]="{'active': (questions[index].voteChoice && questions[index].voteChoice[0].voteChoiceId === choice._id) || choice.isVote,'closed': data.post.closed || isVoteAlready}"
                                            (click)="chooseChoice(item,choice,index,i,item.type)">
                                            <div class="choice">
                                                <div class="image" *ngIf="!!choice.coverPageURL">
                                                    <display-gallery [gallery]="[{imageURL: choice.coverPageURL}]"
                                                        (clickShowImage)="showDialogGallery($event)"></display-gallery>
                                                </div>
                                                <div class="answer">
                                                    <span>{{choice.title}}</span>
                                                    <!-- (click)="addOrRemoveActive(choice,'single','remove',index); $event.stopPropagation()" -->
                                                    <div class="border-white" *ngIf="!data.post.closed">
                                                        <button mat-icon-button
                                                            (click)="addOrRemoveActive(choice,'single','remove',index); $event.stopPropagation()"
                                                            *ngIf="(questions[index].voteChoice && questions[index].voteChoice[0].voteChoiceId === choice._id) || choice.isVote">
                                                            <mat-icon>done</mat-icon>
                                                        </button>
                                                    </div>
                                                </div>
                                                <ng-container
                                                    *ngIf="!data.post.showVoteResult || (data.post.closed && data.post.showVoteResult)">
                                                    <span>{{item.voteChoice[i].voted.length > 0 ?
                                                        item.voteChoice[i].voted[0].votedCount : 0}}</span>
                                                </ng-container>
                                            </div>
                                            <ng-container
                                                *ngIf="!data.post.showVoteResult || (data.post.closed && data.post.showVoteResult)">
                                                <mat-progress-bar mode="determinate"
                                                    [value]="voteChoiceValue[index].value[i]"></mat-progress-bar>
                                            </ng-container>
                                        </div>
                                    </ng-container>
                                    <ng-template #elseMultiple>
                                        <div class="wrapper-choice" role="button"
                                            [ngClass]="{'active': choice.active || choice.isVote,'closed': data.post.closed || isVoteAlready}"
                                            (click)="!choice.active ? chooseChoice(item,choice,index,i,item.type) : null;
                                            choice.active ? addOrRemoveActive(choice,'multi','remove',index,i) : addOrRemoveActive(choice,'multi','add',index,i)">
                                            <div class="choice">
                                                <div class="image" *ngIf="!!choice.coverPageURL">
                                                    <display-gallery [gallery]="[{imageURL: choice.coverPageURL}]"
                                                        (clickShowImage)="showDialogGallery($event)"></display-gallery>
                                                </div>
                                                <div class="answer">
                                                    <span>{{choice.title}}</span>
                                                    <mat-icon *ngIf="choice.active || choice.isVote"
                                                        class="material-icons-round">done</mat-icon>
                                                </div>
                                                <ng-container
                                                    *ngIf="!data.post.showVoteResult || (data.post.closed && data.post.showVoteResult)">
                                                    <span>{{item.voteChoice[i].voted.length > 0 ?
                                                        item.voteChoice[i].voted[0].votedCount : 0}}</span>
                                                </ng-container>
                                            </div>
                                            <ng-container
                                                *ngIf="!data.post.showVoteResult || (data.post.closed && data.post.showVoteResult)">
                                                <mat-progress-bar mode="determinate"
                                                    [value]="voteChoiceValue[index].value[i]"></mat-progress-bar>
                                            </ng-container>
                                        </div>
                                    </ng-template>
                                </ng-container>
                                <ng-container *ngIf="item.type === 'text'">
                                    <ng-container *ngIf="data.post.closed; else elseCloseText">
                                        <button mat-button class="button-vote close"
                                            (click)="item.voted.length > 0 ? seeVoteTextUser(item._id) : null">
                                            <ng-container *ngIf="item.voted.length > 0; else elseTextLength">
                                                <span
                                                    [innerHTML]="'ดูทั้งหมด (' + item.voted[0].votedCount + ')'"></span>
                                            </ng-container>
                                            <ng-template #elseTextLength>
                                                <span [innerHTML]="'ดูทั้งหมด (0)'"></span>
                                            </ng-template>
                                        </button>
                                    </ng-container>
                                    <ng-template #elseCloseText>
                                        <div class="wrapper-answer-vote">
                                            <input [ngStyle]="{'pointer-events': data.post.closed ? 'none' : 'unset'}"
                                                type="text" placeholder="ตอบคำถาม"
                                                [(ngModel)]="isVoteAlready ? item.answerData.answer : answerTextbox[index]"
                                                [attr.disabled]="isVoteAlready ? true : null"
                                                (keyup)="setAnswer(item,index)">
                                            <button mat-icon-button *ngIf="isVoteAlready"
                                                (click)="seeAnswerTextUser(item.answerData.answer)">
                                                <mat-icon>visibility</mat-icon>
                                            </button>
                                        </div>
                                    </ng-template>
                                </ng-container>
                                <div class="next" *ngIf="!data.post.closed && index === posts.length - 1">
                                    <span [ngClass]="{'voted': isVoteAlready}" role="button"
                                        (click)="isLogin() ? next() : checkLogin()">ถัดไป</span>
                                </div>
                            </div>
                        </ng-container>
                    </ng-container>
                    <ng-template #elseApproved>
                        <div class="wrapper-button" *ngIf="data.post.status !== 'close'">
                            <ng-container *ngIf="data.post.userSupport; else elseSupport">
                                <span class="button-vote close" role="button" [attr.aria-label]="'ยกเลิกสนับสนุน'"
                                    (click)="isLogin() ? unVoteSupport(data.post._id) : checkLogin()">ยกเลิกสนับสนุน</span>
                            </ng-container>
                            <ng-template #elseSupport>
                                <span class="button-vote submit" role="button" [ngClass]="{'disabled': isCantVote}"
                                    [attr.aria-label]="'สนับสนุน'"
                                    (click)="isLogin() ? voteSupport(data.post._id) : checkLogin()">สนับสนุน</span>
                            </ng-template>
                        </div>
                    </ng-template>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="voteSuccess" class="dialog-vote-card vote-success">
        <div class="wrapper-card vote-success">
            <img class="close-icon" src="../../../../assets/img/icons/votepage/close.svg" role="button"
                (click)="onClose()">
            <div class="card">
                <span>{{data.post.service ? data.post.service : 'ขอขอบคุณสำหรับเวลาและการโหวตของท่าน'}}</span>
                <div class="success-vote" role="button" (click)="onClose()">
                    <span>เสร็จสิ้น</span>
                </div>
            </div>
        </div>
    </div>
</ng-container>
<ng-template #elseTemplate>
    <div class="dialog_post_card">

        <span mat-dialog-title class="onClose" role="button" (click)="onClose($event)">
            <svg version="1.1" width="20px" id="Capa_1" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 41.756 41.756"
                style="enable-background:new 0 0 41.756 41.756;" xml:space="preserve">
                <g>
                    <path
                        d="M27.948,20.878L40.291,8.536c1.953-1.953,1.953-5.119,0-7.071c-1.951-1.952-5.119-1.952-7.07,0L20.878,13.809L8.535,1.465
            c-1.951-1.952-5.119-1.952-7.07,0c-1.953,1.953-1.953,5.119,0,7.071l12.342,12.342L1.465,33.22c-1.953,1.953-1.953,5.119,0,7.071
            C2.44,41.268,3.721,41.755,5,41.755c1.278,0,2.56-0.487,3.535-1.464l12.343-12.342l12.343,12.343
            c0.976,0.977,2.256,1.464,3.535,1.464s2.56-0.487,3.535-1.464c1.953-1.953,1.953-5.119,0-7.071L27.948,20.878z" />
                </g>
            </svg>
        </span>

        <mat-dialog-content [class.hide]="isRepost">
            <post-data *ngIf="!showLoading" [itemPost]="data.post" [ownerPost]="data.user" [isComments]="isLogin()"
                [isUserPage]="false" [isShowUser]="true" [isNotAccess]="data.isNotAccess" [isPage]="data.isNotAccess"
                (action)="actionComment($event)" [pageUser]="data.pageUser" (comment)="createComment($event)">
            </post-data>
            <Preload-card *ngIf="showLoading" [isShowCard4]="true" [class]="'preload-profile'">
            </Preload-card>
        </mat-dialog-content>
    </div>
</ng-template>

<loading *ngIf="isLoading"></loading>